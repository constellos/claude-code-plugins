name: UI Review

# Automated UI review using Playwright screenshots and Claude Code ui-reviewer agent
# Runs on PRs when Vercel preview URLs are available, blocks if critical UI issues are found

on:
  pull_request:
    branches:
      - '**'

jobs:
  ui-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Playwright browsers
        run: npx -y playwright@latest install chromium --with-deps

      - name: Wait for Vercel preview deployments
        id: vercel
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for Vercel preview deployments..."

          # For PR: extract PR number
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            # For push: try to find associated PR
            PR_NUMBER=$(gh pr list --json number,headRefName --jq ".[] | select(.headRefName==\"${GITHUB_REF_NAME}\") | .number" | head -1)
          fi

          echo "PR Number: $PR_NUMBER"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found, skipping Vercel preview check"
            echo "has_preview=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Poll for Vercel preview URLs (max 10 minutes)
          MAX_WAIT=600
          ELAPSED=0
          INTERVAL=10

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Get PR comments and look for Vercel bot
            PREVIEW_URLS=$(gh pr view $PR_NUMBER --json comments --jq '.comments[].body' | grep -oP 'https://[a-z0-9-]+\.vercel\.app' | sort -u || echo "")

            if [ -n "$PREVIEW_URLS" ]; then
              echo "Found Vercel preview URLs:"
              echo "$PREVIEW_URLS"
              echo "has_preview=true" >> $GITHUB_OUTPUT
              echo "preview_urls<<EOF" >> $GITHUB_OUTPUT
              echo "$PREVIEW_URLS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              break
            fi

            echo "No preview URLs yet, waiting..."
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "Timeout waiting for Vercel preview URLs"
            echo "has_preview=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Playwright e2e tests
        if: steps.vercel.outputs.has_preview == 'true'
        id: playwright
        env:
          PREVIEW_URLS: ${{ steps.vercel.outputs.preview_urls }}
        run: |
          # Parse preview URLs into array
          readarray -t URLS <<< "$PREVIEW_URLS"

          # Create screenshots directory
          mkdir -p .claude/screenshots

          # Run Playwright tests for app and web only (isolated)
          for URL in "${URLS[@]}"; do
            if [ -z "$URL" ]; then
              continue
            fi

            # Extract app name from URL (e.g., my-app-web-abc.vercel.app -> web)
            APP_NAME=$(echo "$URL" | grep -oP '(?<=-)(app|web)(?=-[a-z0-9]+\.vercel\.app)' || echo "")

            # Only run tests for app or web
            if [ "$APP_NAME" != "app" ] && [ "$APP_NAME" != "web" ]; then
              echo "Skipping $URL (not app or web)"
              continue
            fi

            echo "Running e2e tests for $APP_NAME at $URL"

            # Run Playwright tests with screenshots enabled
            # Tests should be tagged with @app or @web
            # Screenshots are taken during test execution at key moments
            npx playwright test \
              --grep="@$APP_NAME" \
              --project=chromium \
              --reporter=list,html \
              -c playwright.config.ts || true

            # Screenshots are automatically saved by Playwright to test-results/
            # Move them to .claude/screenshots/ with proper naming
            find test-results -name "*.png" -type f | while read -r screenshot; do
              TEST_NAME=$(basename "$(dirname "$screenshot")")
              FILENAME="${APP_NAME}-${TEST_NAME}-$(basename "$screenshot")"
              cp "$screenshot" ".claude/screenshots/$FILENAME"
            done
          done

          # Count total screenshots
          SCREENSHOT_COUNT=$(ls -1 .claude/screenshots/*.png 2>/dev/null | wc -l)
          echo "screenshots_count=$SCREENSHOT_COUNT" >> $GITHUB_OUTPUT
          echo "Captured $SCREENSHOT_COUNT screenshots from e2e tests"

      - name: Review UI with Claude
        if: steps.playwright.outputs.screenshots_count > 0
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Reviewing UI screenshots with Claude..."

          # Read ui-reviewer agent instructions
          UI_REVIEWER_PROMPT=$(cat shared/agents/ui-reviewer.md)

          # Initialize review results
          CRITICAL_ISSUES=0
          MAJOR_ISSUES=0
          MINOR_ISSUES=0
          REVIEWS=""

          # Group screenshots by app and test
          # Format: app-testname-screenshot.png or web-testname-screenshot.png
          for APP in app web; do
            # Get unique test names for this app
            TESTS=$(ls -1 .claude/screenshots/${APP}-*.png 2>/dev/null | \
                    sed "s/.*\/${APP}-\([^-]*\)-.*/\1/" | sort -u || echo "")

            if [ -z "$TESTS" ]; then
              continue
            fi

            echo "Reviewing $APP tests..."

            # Review each test separately
            for TEST in $TESTS; do
              echo "  Reviewing test: $TEST"

              # Get all screenshots for this test
              SCREENSHOTS=$(ls -1 .claude/screenshots/${APP}-${TEST}-*.png 2>/dev/null || echo "")

              if [ -z "$SCREENSHOTS" ]; then
                continue
              fi

              # Create Claude API call with vision for this test
              # Convert images to base64 and create API request
              IMAGE_CONTENT=""
              for SCREENSHOT in $SCREENSHOTS; do
                BASE64_IMAGE=$(base64 -w 0 "$SCREENSHOT")
                IMAGE_CONTENT="${IMAGE_CONTENT}
                {
                  \"type\": \"image\",
                  \"source\": {
                    \"type\": \"base64\",
                    \"media_type\": \"image/png\",
                    \"data\": \"${BASE64_IMAGE}\"
                  }
                }"
              done

              # Call Claude API with vision
              RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
                -H "x-api-key: $ANTHROPIC_API_KEY" \
                -H "anthropic-version: 2023-06-01" \
                -H "content-type: application/json" \
                -d "{
                  \"model\": \"claude-sonnet-4-5-20250929\",
                  \"max_tokens\": 4096,
                  \"messages\": [{
                    \"role\": \"user\",
                    \"content\": [
                      {
                        \"type\": \"text\",
                        \"text\": \"${UI_REVIEWER_PROMPT}\n\nReview these UI screenshots from the ${APP} app, test: ${TEST}. Identify critical, major, and minor issues. Return JSON: {\\\"critical\\\": number, \\\"major\\\": number, \\\"minor\\\": number, \\\"summary\\\": string}\"
                      }
                      ${IMAGE_CONTENT}
                    ]
                  }]
                }")

              # Parse response (simplified - assumes JSON in content[0].text)
              TEST_REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text')
              TEST_CRITICAL=$(echo "$TEST_REVIEW" | jq -r '.critical // 0')
              TEST_MAJOR=$(echo "$TEST_REVIEW" | jq -r '.major // 0')
              TEST_MINOR=$(echo "$TEST_REVIEW" | jq -r '.minor // 0')
              TEST_SUMMARY=$(echo "$TEST_REVIEW" | jq -r '.summary // "No review available"')

              # Aggregate counts
              CRITICAL_ISSUES=$((CRITICAL_ISSUES + TEST_CRITICAL))
              MAJOR_ISSUES=$((MAJOR_ISSUES + TEST_MAJOR))
              MINOR_ISSUES=$((MINOR_ISSUES + TEST_MINOR))

              # Append to reviews
              REVIEWS="${REVIEWS}
          ### ${APP} - ${TEST}

          - Critical: ${TEST_CRITICAL}
          - Major: ${TEST_MAJOR}
          - Minor: ${TEST_MINOR}

          ${TEST_SUMMARY}
          "
            done
          done

          # Determine if blocking
          HAS_CRITICAL=$([ $CRITICAL_ISSUES -gt 0 ] && echo "true" || echo "false")
          echo "has_critical_issues=$HAS_CRITICAL" >> $GITHUB_OUTPUT
          echo "review_summary=Critical: $CRITICAL_ISSUES, Major: $MAJOR_ISSUES, Minor: $MINOR_ISSUES" >> $GITHUB_OUTPUT

          # Save review report
          cat > .claude/ui-review-report.md << REPORT
          # UI Review Report

          **Commit**: ${{ github.sha }}
          **PR**: ${{ steps.vercel.outputs.pr_number }}
          **Screenshots**: ${{ steps.playwright.outputs.screenshots_count }}

          ## Summary

          - **Critical issues**: ${CRITICAL_ISSUES}
          - **Major issues**: ${MAJOR_ISSUES}
          - **Minor issues**: ${MINOR_ISSUES}

          ## Test Reviews
          ${REVIEWS}

          $([ $CRITICAL_ISSUES -gt 0 ] && echo "❌ **BLOCKED**: Critical issues found" || echo "✅ **PASSED**: No critical issues")
          REPORT

          echo "Review report saved to .claude/ui-review-report.md"

      - name: Upload screenshots artifact
        if: steps.playwright.outputs.screenshots_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: ui-screenshots-${{ github.sha }}
          path: .claude/screenshots/
          retention-days: 7

      - name: Upload review report
        if: steps.playwright.outputs.screenshots_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: ui-review-report-${{ github.sha }}
          path: .claude/ui-review-report.md
          retention-days: 7

      - name: Post review to PR
        if: steps.vercel.outputs.pr_number && steps.playwright.outputs.screenshots_count > 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.vercel.outputs.pr_number }}
        run: |
          # Post review report as PR comment
          gh pr comment $PR_NUMBER --body-file .claude/ui-review-report.md

      - name: Block on critical issues
        if: steps.review.outputs.has_critical_issues == 'true'
        run: |
          echo "❌ Critical UI issues found!"
          echo "${{ steps.review.outputs.review_summary }}"
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "=== UI Review Summary ==="
          echo "Screenshots captured: ${{ steps.playwright.outputs.screenshots_count }}"
          echo "Review status: ${{ steps.review.outputs.review_summary || 'Skipped' }}"
          echo "Critical issues: ${{ steps.review.outputs.has_critical_issues || 'false' }}"
