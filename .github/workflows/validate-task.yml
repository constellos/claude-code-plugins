name: Validate Task Completion

# This workflow validates that task completions (subagent commits) meet requirements
# Triggered by commits with Agent-ID git trailers

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  validate-task:
    runs-on: ubuntu-latest
    # Only run on commits with Agent-ID trailer (from subagent commits)
    if: contains(github.event.head_commit.message, 'Agent-ID:')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need at least 2 commits to see changes

      - name: Extract commit metadata
        id: metadata
        run: |
          # Extract git trailers from commit message
          COMMIT_MSG=$(git log -1 --format=%B)

          echo "Full commit message:"
          echo "$COMMIT_MSG"
          echo ""

          # Extract trailers
          AGENT_TYPE=$(echo "$COMMIT_MSG" | grep -oP '^Agent-Type: \K.*' || echo "unknown")
          AGENT_ID=$(echo "$COMMIT_MSG" | grep -oP '^Agent-ID: \K.*' || echo "unknown")
          FILES_EDITED=$(echo "$COMMIT_MSG" | grep -oP '^Files-Edited: \K.*' || echo "0")
          FILES_NEW=$(echo "$COMMIT_MSG" | grep -oP '^Files-New: \K.*' || echo "0")
          FILES_DELETED=$(echo "$COMMIT_MSG" | grep -oP '^Files-Deleted: \K.*' || echo "0")

          echo "agent_type=$AGENT_TYPE" >> $GITHUB_OUTPUT
          echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT
          echo "files_edited=$FILES_EDITED" >> $GITHUB_OUTPUT
          echo "files_new=$FILES_NEW" >> $GITHUB_OUTPUT
          echo "files_deleted=$FILES_DELETED" >> $GITHUB_OUTPUT

          echo "Extracted metadata:"
          echo "  Agent Type: $AGENT_TYPE"
          echo "  Agent ID: $AGENT_ID"
          echo "  Files Edited: $FILES_EDITED"
          echo "  Files New: $FILES_NEW"
          echo "  Files Deleted: $FILES_DELETED"

      - name: Get changed files
        id: changes
        run: |
          # Get list of changed files in this commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || git diff --name-only HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Export as multiline output
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate task completion
        env:
          AGENT_TYPE: ${{ steps.metadata.outputs.agent_type }}
          AGENT_ID: ${{ steps.metadata.outputs.agent_id }}
          FILES_EDITED: ${{ steps.metadata.outputs.files_edited }}
          CHANGED_FILES: ${{ steps.changes.outputs.files }}
        run: |
          echo "=== Task Validation ==="
          echo "Agent Type: $AGENT_TYPE"
          echo "Agent ID: $AGENT_ID"
          echo "Files Modified: $FILES_EDITED"
          echo ""
          echo "Changed files in commit:"
          echo "$CHANGED_FILES"
          echo ""

          # TODO: Add actual validation logic here
          # - Match changed files to .claude/rules/*.md patterns
          # - Extract rule requirements from frontmatter
          # - Validate against task prompt (if available)
          # - Check for rule violations

          echo "âœ“ Task validation passed (placeholder)"

      - name: Report validation status
        if: always()
        run: |
          echo "Task validation complete for agent ${{ steps.metadata.outputs.agent_id }}"
          # TODO: Post status to PR or commit status API
